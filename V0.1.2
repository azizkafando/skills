<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boutique de Vêtements Éphémère</title>
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuration des polices et des styles généraux de Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5', // Indigo
                        'secondary': '#facc15', // Amber
                    }
                }
            }
        }
    </script>
    <style>
        /* Définition de la police Inter (optionnel si non déjà chargé par défaut) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">

    <!-- En-tête de l'application -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-primary tracking-tight">
                Vêtements Éphémères
            </h1>
            <div id="auth-status" class="text-sm text-gray-500 flex items-center">
                <!-- ID Utilisateur affiché ici -->
            </div>
            <!-- Bouton du Panier (visible sur mobile/desktop) -->
            <button id="toggle-cart-btn" class="relative p-2 rounded-full bg-primary text-white hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.023.824l.744 4.148m0 0a.75.75 0 010 1.5H5.823l.791 4.354a.75.75 0 00.72 1.09h10.428a.75.75 0 00.72-1.09l.79-4.354a.75.75 0 00-.72-1.09h-10.428a.75.75 0 010-1.5H21.75a.75.75 0 00-.72-1.09l-.79-4.354A.75.75 0 0019.236 4.5H4.11L3.585 1.5H2.25" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zm-7.5 0a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
                </svg>
                <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-secondary rounded-full">0</span>
            </button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid md:grid-cols-3 gap-8">
            <!-- Colonne Principale: Liste des Produits (2/3 sur desktop) -->
            <div class="md:col-span-2">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Nos Articles</h2>
                <div id="product-list-container" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                    <div id="loading-indicator" class="col-span-full text-center py-10 text-gray-500">Chargement des produits...</div>
                    <!-- Les cartes de produits seront injectées ici -->
                </div>
            </div>

            <!-- Colonne Panier (1/3 sur desktop, caché sur mobile) -->
            <div id="cart-desktop-view" class="hidden md:block md:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit sticky top-24">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Votre Panier</h2>
                <div id="cart-items-desktop">
                    <!-- Les articles du panier seront injectés ici -->
                </div>
                <div id="cart-summary-desktop" class="mt-4 pt-4 border-t border-gray-200">
                    <div class="flex justify-between font-bold text-lg text-gray-900">
                        <span>Total:</span>
                        <span id="cart-total-desktop">0.00 €</span>
                    </div>
                    <button id="checkout-btn-desktop" class="mt-4 w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-indigo-600 transition disabled:opacity-50" disabled>
                        Passer la commande
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal/Overlay du Panier (pour mobile) -->
    <div id="cart-mobile-modal" class="fixed inset-0 bg-white z-50 transform translate-x-full transition-transform duration-300 md:hidden overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Votre Panier</h2>
                <button id="close-cart-btn" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-8 h-8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="cart-items-mobile" class="space-y-4">
                <!-- Les articles du panier seront injectés ici -->
            </div>
            <div id="cart-summary-mobile" class="mt-6 pt-6 border-t border-gray-200 sticky bottom-0 bg-white">
                <div class="flex justify-between font-bold text-xl text-gray-900 mb-4">
                    <span>Total:</span>
                    <span id="cart-total-mobile">0.00 €</span>
                </div>
                <button id="checkout-btn-mobile" class="w-full bg-primary text-white py-4 rounded-lg font-semibold hover:bg-indigo-600 transition disabled:opacity-50" disabled>
                    Passer la commande
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de confirmation / message box (pour les messages d'erreur/succès) -->
    <div id="message-box" class="fixed bottom-4 right-4 z-50 transition-transform duration-300 transform translate-x-full">
        <!-- Message Box Content -->
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, runTransaction, arrayRemove, arrayUnion, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Désactiver les logs de débogage dans un environnement de production
        // setLogLevel('Debug'); // Décommenter pour voir les logs Firestore détaillés

        // --- GLOBAL VARIABLES & INITIALIZATION ---

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Collections Paths
        const PRODUCT_COLLECTION = `artifacts/${appId}/public/data/clothing_products`;
        const CART_COLLECTION = () => `artifacts/${appId}/users/${userId}/user_cart`;

        // UI Elements
        const productListContainer = document.getElementById('product-list-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const cartCountSpan = document.getElementById('cart-count');
        const authStatusDiv = document.getElementById('auth-status');
        
        // Cart UI
        const cartDesktopItems = document.getElementById('cart-items-desktop');
        const cartMobileItems = document.getElementById('cart-items-mobile');
        const cartDesktopTotal = document.getElementById('cart-total-desktop');
        const cartMobileTotal = document.getElementById('cart-total-mobile');
        const checkoutBtnDesktop = document.getElementById('checkout-btn-desktop');
        const checkoutBtnMobile = document.getElementById('checkout-btn-mobile');
        const cartMobileModal = document.getElementById('cart-mobile-modal');
        const toggleCartBtn = document.getElementById('toggle-cart-btn');
        const closeCartBtn = document.getElementById('close-cart-btn');
        const messageBox = document.getElementById('message-box');

        let products = [];
        let cartItems = {}; // { productId: { quantity: N, price: P, name: S } }

        // --- UTILITY FUNCTIONS ---

        /**
         * Affiche un message de succès ou d'erreur dans une boîte flottante.
         * @param {string} message - Le message à afficher.
         * @param {string} type - 'success' ou 'error'.
         */
        function showMessage(message, type = 'success') {
            const color = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' ? 
                '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-2"> <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /> </svg>' :
                '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-2"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.86-1.503-.497-3.37.94-4.825 2.07-2.146 5.176-2.656 7.647-1.423 2.145 1.085 3.518 3.12 3.518 5.397.0 2.52-1.748 4.63-4.22 5.06-2.47.43-5.228-.68-6.666-2.545C2.65 17.065 2.287 15.19 3.147 13.687z" /> </svg>';
            
            messageBox.innerHTML = `
                <div class="${color} text-white p-4 rounded-xl shadow-2xl flex items-center max-w-sm">
                    ${icon}
                    <p class="font-semibold">${message}</p>
                </div>
            `;
            // Slide in
            messageBox.classList.remove('translate-x-full');
            
            // Slide out after 4 seconds
            setTimeout(() => {
                messageBox.classList.add('translate-x-full');
            }, 4000);
        }

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. App will run without persistence.");
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Gérer l'authentification
                const initialAuthPromise = initialAuthToken 
                    ? signInWithCustomToken(auth, initialAuthToken)
                    : signInAnonymously(auth);

                await initialAuthPromise;

                // Listen to Auth State Changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Authentication successful. User ID:", userId);
                        authStatusDiv.innerHTML = `<span class="text-xs font-semibold uppercase text-gray-500">ID Utilisateur:</span> <span class="text-sm font-mono text-gray-700 ml-1 truncate max-w-xs">${userId}</span>`;
                        
                        // Start listening to data only when auth is ready
                        listenToProducts();
                        listenToCart();
                    } else {
                        userId = crypto.randomUUID(); // Fallback ID if sign-in fails unexpectedly
                        isAuthReady = true;
                        authStatusDiv.innerHTML = `<span class="text-xs font-semibold uppercase text-red-500">Authentification Échouée</span>`;
                        console.error("Authentication failed or logged out. Using temporary ID:", userId);
                        
                        // Attempt to listen with fallback ID (will fail if security rules are strict)
                        listenToProducts();
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization or authentication:", error);
                loadingIndicator.textContent = "Erreur de connexion à la base de données.";
            }
        }

        // --- PRODUCT MANAGEMENT (PUBLIC) ---

        /** Mock initial product data */
        const MOCK_PRODUCTS = [
            { id: 'tshirt-001', name: 'T-Shirt Coton Bio', description: 'T-shirt unisexe en coton 100% biologique. Disponible en S, M, L, XL.', price: 29.99, imageUrl: 'https://placehold.co/400x400/2563eb/ffffff?text=T-SHIRT', category: 'Haut' },
            { id: 'hoodie-002', name: 'Sweat à Capuche Zippé', description: 'Molleton brossé, idéal pour le confort et le style décontracté.', price: 59.99, imageUrl: 'https://placehold.co/400x400/f59e0b/000000?text=HOODIE', category: 'Haut' },
            { id: 'jeans-003', name: 'Jean Slim Éco-Responsable', description: 'Coupe ajustée et denim durable. Lavage indigo classique.', price: 79.99, imageUrl: 'https://placehold.co/400x400/10b981/000000?text=JEANS', category: 'Bas' },
            { id: 'dress-004', name: 'Robe Midi Fleurie', description: 'Robe légère parfaite pour l\'été, avec ceinture assortie.', price: 45.50, imageUrl: 'https://placehold.co/400x400/ec4899/ffffff?text=ROBE', category: 'Robe' },
        ];

        /**
         * Ajoute les produits initiaux si la collection est vide.
         */
        async function seedProducts() {
            try {
                const productsRef = collection(db, PRODUCT_COLLECTION);
                const snapshot = await getDocs(productsRef);

                if (snapshot.empty) {
                    console.log("Collection de produits vide. Ajout des produits initiaux...");
                    const batch = writeBatch(db);
                    
                    MOCK_PRODUCTS.forEach(product => {
                        const productDocRef = doc(productsRef, product.id);
                        batch.set(productDocRef, product);
                    });

                    await batch.commit();
                    console.log("Produits initiaux ajoutés avec succès.");
                }
            } catch (error) {
                console.error("Erreur lors de l'initialisation des produits:", error);
                showMessage("Erreur lors du chargement des produits initiaux.", 'error');
            }
        }
        
        /**
         * Écoute en temps réel les changements dans la collection de produits.
         */
        function listenToProducts() {
            if (!db) return;
            const productsRef = collection(db, PRODUCT_COLLECTION);
            
            // On s'assure que les produits mock sont là avant l'écoute
            seedProducts(); 

            onSnapshot(productsRef, (snapshot) => {
                products = [];
                snapshot.forEach(doc => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                renderProducts();
            }, (error) => {
                console.error("Erreur lors de l'écoute des produits:", error);
                loadingIndicator.textContent = "Erreur de chargement des produits.";
            });
        }

        /**
         * Rend la liste des produits dans l'interface utilisateur.
         */
        function renderProducts() {
            loadingIndicator.remove(); // Remove loading indicator once data is available
            productListContainer.innerHTML = ''; // Clear previous content

            if (products.length === 0) {
                productListContainer.innerHTML = '<p class="col-span-full text-center py-10 text-gray-500">Aucun produit n\'est disponible pour le moment.</p>';
                return;
            }

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-white rounded-xl shadow-lg overflow-hidden flex flex-col hover:shadow-xl transition duration-300';
                
                productCard.innerHTML = `
                    <div class="h-64 overflow-hidden">
                        <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='https://placehold.co/400x400/9ca3af/ffffff?text=Image+Indisponible';" />
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <span class="text-xs font-semibold text-primary uppercase mb-1">${product.category}</span>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${product.name}</h3>
                        <p class="text-sm text-gray-600 mb-4 flex-grow">${product.description}</p>
                        <div class="flex justify-between items-center mt-auto">
                            <span class="text-2xl font-extrabold text-gray-800">${product.price.toFixed(2)} €</span>
                            <button data-id="${product.id}" class="add-to-cart-btn px-4 py-2 bg-secondary text-gray-900 font-semibold rounded-lg hover:bg-amber-500 transition shadow-md">
                                Ajouter au Panier
                            </button>
                        </div>
                    </div>
                `;
                productListContainer.appendChild(productCard);
            });

            // Re-attach event listeners for "Add to Cart" buttons
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.dataset.id;
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        addToCart(productId, product.name, product.price);
                    }
                });
            });
        }

        // --- CART MANAGEMENT (PRIVATE) ---

        /**
         * Écoute en temps réel les changements du panier de l'utilisateur.
         */
        function listenToCart() {
            if (!db || !userId) return;
            const cartRef = doc(db, CART_COLLECTION(), 'current_cart');
            
            onSnapshot(cartRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Les données du panier sont stockées sous le champ 'items'
                    const data = docSnap.data();
                    cartItems = data.items || {};
                } else {
                    cartItems = {}; // Panier vide si le document n'existe pas
                }
                renderCart();
            }, (error) => {
                console.error("Erreur lors de l'écoute du panier:", error);
                showMessage("Erreur de chargement du panier.", 'error');
            });
        }

        /**
         * Ajoute un produit au panier ou augmente sa quantité.
         * @param {string} productId - L'ID du produit.
         * @param {string} name - Nom du produit.
         * @param {number} price - Prix unitaire.
         */
        async function addToCart(productId, name, price) {
            if (!userId) { showMessage("Veuillez attendre l'initi
